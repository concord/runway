---

- name: Sync soure from git
  git:
    repo='https://github.com/senior7515/librdkafka.git'
    accept_hostkey=yes
    clone=yes
    dest='{{cache_dir}}/librdkafka'
    update=yes
    recursive=yes
    version='64cd2ab'
    force=yes

- shell:
    ./configure --CFLAGS="-O2 -DNDEBUG -fPIC" \
    --CXXFLAGS="-O2 -DNDEBUG -fPIC" --prefix="{{third_party_dir}}"
  args:
    chdir: '{{cache_dir}}/librdkafka'
    creates: '{{cache_dir}}/librdkafka/Makefile.config'

- command: make -j{{ansible_processor_vcpus}}
  args:
    chdir: '{{cache_dir}}/librdkafka'
    creates: '{{cache_dir}}/librdkafka/src/librdkafka.a'

- command: make install
  args:
    chdir: '{{cache_dir}}/librdkafka'
    creates: '{{third_party_dir}}/lib/librdkafka.a'
